<html><head><script src="jquery-1.6.4.min.js"></script><script>

  // --- begin arrays, remember stuff about tabs ---

  // here: if tab is before or after a ``sudo'' reload action   
  // (so as to avoid placing the ``sudo'' button 
  // in a sudo-reloaded tab)
  var array_mytabs_sudomem; 

  // here: if a tab started as a (facebook) login tab. 
  // if this tab is no longer under (facebook) domain, 
  // kill it
  var array_mytabs_logintab; 
  // here: exclude this tab from tab refresh
  var array_mytabs_refreshexclude; 

  // here: URL to be spawned in a tab 
  // once this tab is closed
  var array_mytabs_callbacks;

  // -- end arrays, remember stuff about tabs ---


  // message passing port between 
  // background and options page
  var port_options = null;


  // function 101: here begins everything
  function init() {
    //alert('[DEBUG] background init:: HelloWorld!');
    console.log('[DEBUG] background init:: HelloWorld!');

    array_mytabs_sudomem = new Array();
    array_mytabs_logintab = new Array();
    array_mytabs_refreshexclude = new Array();
    array_mytabs_callbacks = new Array();

    // UI candy
    //chrome.browserAction
    //  .setBadgeBackgroundColor({color:[190, 190, 190, 230]});
    //chrome.browserAction.setBadgeText({text:"?"});

    // when a tab is removed, check if there is a 
    // callback URL to be spawned in a tab
    chrome.tabs.onRemoved.addListener(function(tabId, removeInfo) {
      if (array_mytabs_callbacks[tabId] != "" 
          && array_mytabs_callbacks[tabId] != null) {
        if (!removeInfo.isWindowClosing) {
          console.log ("Spawning callback URL: '" 
                       + array_mytabs_callbacks[tabId] + "'");
          chrome.windows.create({url: array_mytabs_callbacks[tabId], 
                                 incognito: true, type: "normal"});
        }
        array_mytabs_callbacks.splice(tabId,1); // remove
      }
    });

    // when a tab is updated, check if it was previously in facebook 
    // domain but no more. if so do kill and refresh all other tabs in window. 
    chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
      if (array_mytabs_logintab[tabId] == 1 
          && !tab.url.match(new RegExp(/^http[s]?:\/\/www.facebook.com/gi))) {
        // login tab changed from fb domain to sth else,
        // do kill and update rest of tabs in this window
        array_mytabs_refreshexclude[tabId] = 1;
        // kill
        chrome.tabs.get(tabId, function(tab) {
          if (tab) chrome.tabs.remove(tabId, function() {});});
        // refresh
        chrome.tabs.getAllInWindow(tab.windowId, function(tabs) {
          var i = 0; for (i = 0; tabs && i < tabs.length; i++) {
            if (array_mytabs_refreshexclude[tabs[i].id] != 1)
              chrome.tabs.update(tabs[i].id, {url: tabs[i].url});
            else array_mytabs_refreshexclude.splice(tabs[i].id,1); // remove
          }
        });
        array_mytabs_logintab.splice(tabId,1); // remove
      }
    });


    // *** *** *** 
    // *** message-passing listener ***
    // *** *** *** 
    // all background does is listen for stuff 
    // (from the content script) and act upon.

    chrome.extension.onConnect.addListener(function(port) {

      if (port.name != "sudoweb_options" 
          && port.name != "sudoweb_page_magic" 
          && port.name != "sudoweb_etc")
          return;

      port.onMessage.addListener(function(msg) {

        if (port.name == "sudoweb_options") port_options = port;

        console.log ("* INCOMING message '" + JSON.stringify(msg) + "'");

// do compare tab's url (message sender) 
// with received tab's referrer

        if (port.sender.tab && msg.referrer) {

          console.log ("* >>> >>> sender.tab & request.referrer report <<<");
          console.log ("* sender.tab.url\t" + port.sender.tab.url 
                       + "\trequest.referrer\t" + msg.referrer);

          // retrieve sender.tab own domain (host)
          var host_current = port.sender.tab.url.split("/")[2];

          // retrieve sender.tab referrer domain (host)
          var host_ref = msg.referrer.split("/")[2];

// >>> begin --- take action: reload url in incognito, 
// downgraded-session (secondary profile) cookies

          if (host_current != host_ref && msg.referrer != "" 
              && host_current == "www.facebook.com") {

            console.log ("* [ALERT] " + host_current + " != " + host_ref);

            // spawn new incongito window with window.opener (parent) of tab
            chrome.windows.create({incognito: true, type: "normal"}, 
              function (newwin) {

                // once new incognito window with window.opener is ready, 
                // do populate with with downgraded cookies (secondary profile)
                // then create tab with url = sender.tab.url
                
                // load profile id 1 in store id 1
                cookies_load (1, 1, function(args) {

                  chrome.tabs.update(args.tabid, {url: args.url});

                  array_mytabs_logintab[args.tabid] = 1;

                  array_mytabs_callbacks[args.tabid] = args.url_callback;

                }, {tabid: newwin.tabs[0].id, 
                    url: port.sender.tab.url, 
                    url_callback: msg.referrer});

            }); // end of window create

            console.log("* Killing tab...");

            chrome.tabs.remove(port.sender.tab.id, function() {});

          }

// >>> end --- take action: reload url in incognito, 
// downgraded-session (secondary profile) cookies

// sender.tab is NOT in our monitored list, do relax, do nothing
          else port.postMessage({verdict: "relax"}); 

        } // end of sender.tab && request.referrer

// on reload (by the sudo button? )

        else if (port.sender.tab && msg.reload) {

          if (msg.reload == "sudo") {

            console.log ("* >>> >>> request.reload (sudo) <<<");

// >>> begin --- take action: reload url (already in incognito), 
// elevated-session (primary profile) cookies

            // load profile id 0 in store id 1
            cookies_load (0, 1, function(args) {
            
              chrome.tabs.update(args.tabid, {url: args.url});
              array_mytabs_sudomem[args.tabid] = "set";

            }, {tabid: port.sender.tab.id, url: port.sender.tab.url});

// >>> end --- take action: reload url (already in incognito), 
// elevated-session (primary profile) cookies

          }

        } //

// >>> --- --- --- <<<
        else if (port.sender.tab && port.sender.tab.incognito 
                 && array_mytabs_sudomem[port.sender.tab.id] != "set") {

          console.log ("* >>> >>> sudoPrompt! <<<");

          port.postMessage({verdict: "sudoPrompt"});

        }

// >>> --- --- --- <<<
        else if (msg.fb_cookies_mem) {

          console.log ("* >>> >>> request.fb_cookies_mem <<<");

          cookies_mem (msg.profile_id, function() {
            port_options.postMessage({owner: "fb_cookies_mem", 
                                      response: null});});
        }

// >>> --- --- --- <<<
        else if (msg.fb_cookies_snapsave) {

          console.log ("* >>> >>> request.fb_cookies_snapsave <<<");

          cookies_mem (2, function() {
            port_options.postMessage({owner: "fb_cookies_snapshot", 
                                      response: null})});

        }

// >>> --- --- --- <<<
        else if (msg.fb_cookies_snapload) {

          console.log ("* >>> >>> request.fb_cookies_snapload <<<");

          cookies_load (2, 0, function() {
            port_options.postMessage({owner: "fb_cookies_snaprestore", 
                                      response: null});});

        }

// >>> --- --- --- <<<
        else if (msg.fb_cookies_clear) {

          console.log ("* >>> >>> request.fb_cookies_clear");

          cookies_clear(function() {
            port_options.postMessage({owner: "fb_cookies_clear", 
                                      response: null});});

        }

// >>> --- --- --- <<<
        else if (msg.fb_cookies_test) {

          console.log ("* >>> >>> request.fb_cookies_test <<<");

          if (msg.profile_id != 0 && msg.profile_id != 1) {

            port_options.postMessage({owner: "fb_cookies_test", 
                                      response: {uid: '0'}}); return;

          }

          console.log("* testing fb_cookies for profile " 
                       + msg.profile_id + "...");

          // load cookies
          if (cookies_load (msg.profile_id, 0, function() {
//
            var http_request = new XMLHttpRequest();
            var url = "https://www.facebook.com/settings";
            http_request.open ("GET", url, false);
            try {
              http_request.send(null);
              if (http_request.status == 200) {
                var fb_name = $('a.headerTinymanName', 
                                http_request.responseText).text();
                if (fb_name == "") {
                  cookies_clear (function() {
                    port_options.postMessage({owner: "fb_cookies_test", 
                                              response: {fb_name: ""}}); 
                    return;});
                }
                console.log (" * testing fb_cookies name is '" 
                             + fb_name + "'");
                port_options.postMessage({owner: "fb_cookies_test", 
                                          response: {fb_name: fb_name}}); 
                return;
              }
              else {
                console.log (" * testing fb_cookies failed due " 
                             + "to http status " + http_request.status);
                port_options.postMessage({owner: "fb_cookies_test", 
                                          response: {fb_name: ""}});
                return;
              }
            } catch (e) {
                console.log (" * testing fb_cookies failed due to exception"); 
                port_options.postMessage({owner: "fb_cookies_test", 
                                          response: {fb_name: ""}}); return;
            }
//
          }) == -1) {
            console.log (" * testing fb_cookies was unable to load " 
                         + "cookies for profile " + msg.profile_id);

            port_options.postMessage({owner: "fb_cookies_test", 
                                      response: {fb_name: ""}}); 
            return;

          }
        }

// >>> --- --- --- <<<
        else if (msg.focus_on_url) {
          chrome.windows.getCurrent(function (win) {
            chrome.tabs.getAllInWindow (win.id, function (tabs) {
              for (var i = 0; i < tabs.length; i++) {
                if (tabs[i].url.indexOf(msg.focus_on_url) == 7 || 
                  tabs[i].url.indexOf(msg.focus_on_url) == 8) {
                    chrome.tabs.update (tabs[i].id, {url: tabs[i].url, 
                                                     selected: true});
                    return;
                }
              }
              chrome.tabs.create({url: "http://" + msg.focus_on_url, 
                                  selected: true});
            });});
        }

// >>> --- --- --- <<<
        else if (msg.nuke_settings) {

          localStorage.clear();

          port_options.postMessage({owner: "nuke_settings", response: null});

        }

// >>> --- --- --- <<<

      }) 
    });

  } // end of init


// === === === ^^^ === === === //

  var newCookies;
  var cookies_load_index;
  var cookies_load_store_id;
  var cookies_load_callback;
  var cookies_load_callback_args;

  // loads fb cookies for profile 'id' into 
  function cookies_load(profile_id, store_id, callback, callback_args) {
    console.log ("* ___ cookies_load profile_id " 
                 + profile_id + " store_id " + store_id);
    if (profile_id != 0 && profile_id != 1 && profile_id != 2) {
      console.log (" * unable to load cookies for invalid profile id " 
                   + profile_id); return -1;
    }
    newCookies = localStorage['mycookies_' + profile_id];
    if (!newCookies || !(newCookies = JSON.parse(newCookies)).length) {
      console.log (" * unable to load mycookies_" 
                   + profile_id + ' profile'); return -1;}
    //newCookies = JSON.parse(newCookies);
    //
    cookies_load_index = 0;
    cookies_load_store_id = store_id;
    cookies_load_callback = callback;
    cookies_load_callback_args = callback_args;
    __cookies_load();
  }


  function __cookies_load () {
    console.log ("  * __cookies_load (" 
                 + (cookies_load_index+1) 
                 + "/" + newCookies.length + ") ='" 
                 + newCookies[cookies_load_index].name 
                 + "' (" + newCookies[cookies_load_index].value + ")");
    var newCookie = newCookies[cookies_load_index++];
    chrome.cookies.set ({url: "http://www.facebook.com", 
                         name: newCookie.name, 
                         value: newCookie.value, 
                         domain: newCookie.domain, 
                         path: newCookie.path, 
                         secure: newCookie.secure, 
                         httpOnly: newCookie.httpOnly, 
                         expirationDate: newCookie.expirationDate, 
                         storeId: cookies_load_store_id + ''}, 
                        function(cookie) {
                          if (!cookie) 
                            console.log (" * __cookies_load fail"); 
                          if (cookies_load_index == newCookies.length 
                              && cookies_load_callback) 
                            // invoke callback and don't load anything else
                            cookies_load_callback(cookies_load_callback_args); 
                            // continue loading more newCookies
                          else __cookies_load();});
  }


  function cookies_mem(profile_id, callback, cb_args) {
    console.log ("* ___ cookies_mem profile_id " + profile_id);
    if (profile_id != 0 && profile_id != 1 && profile_id != 2) {
      console.log(" * unable to mem cookies for invalid profile id");
      callback; return;
    }
    window.localStorage.removeItem('mycookies_' + profile_id);
    chrome.cookies.getAll({'domain': '.facebook.com'}, function(cookies) {
      var cookies_subset = new Array(); var j = 0;
      for (var i = 0; cookies && i < cookies.length; i++)
        if (cookies[i].name == "c_user" || cookies[i].name == "xs") {
          cookies_subset[j++] = cookies[i];
          console.log (" * cookie " + cookies[i].name 
                       + " = " + cookies[i].value);
        }
      if (!localStorage['mycookies_' + '2']) {
        if (!j) cookies_subset = [{"name":"c_user","value":""}, 
                                  {"name":"xs","value":""}];
        localStorage['mycookies_' + '2'] = JSON.stringify(cookies_subset);
      }
      else {
        var id = 0;
        if (localStorage['mycookies_' + id]) id++;
        localStorage['mycookies_' + id] = JSON.stringify(cookies_subset);
      }
      console.log (" * cookies_mem profile_id " + profile_id + " done");
      callback(cb_args);
    });
  }


  // clears (or at least tries to) current fb cookies
  function cookies_clear(callback) {
    console.log ("* ___ cookies_clear");
    chrome.cookies.getAll({'domain': '.facebook.com'}, function(cookies) {
      for (var i = 0; cookies && i < cookies.length; i++)
        chrome.cookies.remove({'url': 'http://www.facebook.com', 
                               'name': cookies[i].name});
      for (var i = 0; cookies && i < cookies.length; i++)
        chrome.cookies.remove({'url': 'https://www.facebook.com', 
                               'name': cookies[i].name});
      // todo: add check here if any .facebook.com cookies are found //
      console.log (" * cookies_clear done");
      callback();
    });
  }


  // register listener for extension button: show options/status page on click
  /*chrome.browserAction.onClicked.addListener(function(tab) {
    chrome.tabs.create({url: chrome.extension.getURL("options.html"), 
                       selected: true});});*/


  // init act: the very first time this bad boy is installed
  if (!localStorage["installdate"]) {
    chrome.tabs.create({url: chrome.extension.getURL("options.html"), 
                        selected: true});
    localStorage["installdate"] = new Date().getTime()
  }

</script></head><body onload="init()"></body></html>
